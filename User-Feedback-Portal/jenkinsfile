pipeline {
    agent any

    environment {
        IMAGE_NAME = "feedback-web"
        IMAGE_TAG = "latest"
        CONTAINER_NAME = "feedback-container"
        APP_PORT = "5000"
        HOST_PORT = "3000"
        APP_DIR = "User-Feedback-Portal"
    }

    options {
        skipStagesAfterUnstable()
        timeout(time: 20, unit: 'MINUTES')
        timestamps()
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo 'üì¶ Cloning repository...'
                checkout scm
                echo '‚úÖ Code checkout completed.'
            }
        }

        stage('Install Dependencies') {
            parallel {
                stage('Backend Deps') {
                    steps {
                        echo '‚öôÔ∏è Installing backend dependencies...'
                        sh '''
                            cd $APP_DIR/backend
                            npm install
                        '''
                        echo '‚úÖ Backend dependencies installed.'
                    }
                }

                stage('Frontend Deps') {
                    steps {
                        echo '‚öôÔ∏è Installing frontend dependencies...'
                        sh '''
                            cd $APP_DIR/frontend
                            npm install
                        '''
                        echo '‚úÖ Frontend dependencies installed.'
                    }
                }
            }
        }

        stage('Build Frontend') {
            steps {
                echo 'üèóÔ∏è Building frontend...'
                sh '''
                    cd $APP_DIR/frontend
                    npm run build || echo "Static HTML app detected ‚Äî skipping build."
                    mkdir -p ../backend/public
                    cp index.html style.css ../backend/public/
                '''
                echo '‚úÖ Frontend build and copy completed.'
            }
        }

        stage('Test Backend') {
            steps {
                echo 'üß™ Testing backend (basic start check)...'
                sh '''
                    cd $APP_DIR/backend
                    node -c server.js
                '''
                echo '‚úÖ Backend syntax check passed.'
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'üê≥ Building Docker image...'
                sh '''
                    docker build -t $IMAGE_NAME:$IMAGE_TAG $APP_DIR
                '''
                echo '‚úÖ Docker image built.'
            }
        }

        stage('Stop Old Container') {
            steps {
                echo 'üßπ Stopping and removing old container if exists...'
                sh '''
                    if [ $(docker ps -q -f name=$CONTAINER_NAME) ]; then
                        docker stop $CONTAINER_NAME
                        docker rm $CONTAINER_NAME
                    fi
                '''
                echo '‚úÖ Old container cleaned up.'
            }
        }

        stage('Deploy New Container') {
            steps {
                echo 'üöÄ Deploying new version of the container...'
                sh '''
                    docker run -d \
                    -p $HOST_PORT:$APP_PORT \
                    --name $CONTAINER_NAME \
                    $IMAGE_NAME:$IMAGE_TAG
                '''
                echo '‚úÖ Container deployed.'
            }
        }

        stage('Cleanup Old Images') {
            steps {
                echo 'üßº Cleaning up unused Docker resources...'
                sh '''
                    docker image prune -af || true
                    docker system prune -f --volumes || true
                '''
                echo '‚úÖ Docker cleanup completed.'
            }
        }

        // Optional health check (uncomment if needed)
           stage('Verify Deployment') {
               steps {
                   echo 'üîç Verifying container response...'
                   sh '''
                       sleep 5
                       if curl -s http://localhost:$HOST_PORT | grep -q "Feedback"; then
                           echo "‚úÖ Frontend reachable"
                       else
                          echo "‚ùå Deployment failed: frontend not responding"
                           exit 1
                       fi
                   '''
               }
           }
    }

    post {
        success {
            echo "‚úÖ CI/CD pipeline completed successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed ‚Äî check logs for details."
        }
    }
}
